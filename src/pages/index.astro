---
import '../styles/global.css';
import { getAllGames } from '../lib/scraper.js';

// Obtener TODOS los partidos
const rawAllGames = await getAllGames();

/**
 * Parsea fecha en formato "DD/MM/YYYY" a objeto Date
 * Establece la hora a 00:00 para comparaci√≥n de d√≠as
 */
function parseDate(dateStr: string): Date | null {
  if (!dateStr || typeof dateStr !== 'string') return null;
  
  const [day, month, year] = dateStr.trim().split('/').map(Number);
  if (!day || !month || !year || day < 1 || day > 31 || month < 1 || month > 12) return null;
  
  const date = new Date(year, month - 1, day, 0, 0, 0, 0);
  
  // Validar que la fecha sea v√°lida
  if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
    return null;
  }
  
  return date;
}

/**
 * Parsea fecha y hora para comparaci√≥n cronol√≥gica precisa
 * Si no hay hora, usa 23:59 para que no desaparezca antes de tiempo
 */
function parseDateTimeForSort(dateStr: string, horaStr: string | undefined): Date | null {
  const date = parseDate(dateStr);
  if (!date) return null;
  
  if (horaStr && typeof horaStr === 'string') {
    const [hours, minutes] = horaStr.trim().split(':').map(Number);
    if (!isNaN(hours) && !isNaN(minutes)) {
      date.setHours(Math.max(0, Math.min(23, hours)) || 0, Math.max(0, Math.min(59, minutes)) || 0, 0, 0);
    } else {
      // Si la hora es inv√°lida, usa 23:59
      date.setHours(23, 59, 0, 0);
    }
  } else {
    // Si no hay hora, usa 23:59 para ese d√≠a
    date.setHours(23, 59, 0, 0);
  }
  
  return date;
}

/**
 * Obtiene la fecha y hora actual
 */
function getNow(): Date {
  return new Date();
}

/**
 * Calcula la fecha l√≠mite (21 d√≠as atr√°s desde hoy)
 */
function getCutoffDate(): Date {
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - 21);
  cutoff.setHours(0, 0, 0, 0);
  return cutoff;
}

// Fecha actual y l√≠mites
const now = getNow();
const cutoffDate = getCutoffDate();

// PROCESAR: A√±adir fecha parseada y determinar si es resultado o pr√≥ximo
const processedGames = rawAllGames
  .map((game: any) => {
    const gameDate = parseDate(game.fecha);
    const gameDateTimeSort = parseDateTimeForSort(game.fecha, game.hora);
    const hasResult = game.marcadorLocal !== null && game.marcadorVisitante !== null && 
                      game.marcadorLocal !== undefined && game.marcadorVisitante !== undefined;
    const isPast = gameDate ? gameDate < now : true;
    const isUpcoming = gameDate ? gameDate >= now && !hasResult : false;
    
    return {
      ...game,
      gameDate,
      gameDateTimeSort,
      hasResult,
      isPast,
      isUpcoming
    };
  })
  // Descartar autom√°ticamente partidos m√°s antiguos de 21 d√≠as (sin resultado)
  .filter((g: any) => {
    // Partidos con resultado: mantener si est√°n dentro de 21 d√≠as
    if (g.hasResult && g.gameDate) {
      return g.gameDate >= cutoffDate;
    }
    // Pr√≥ximos partidos: mantener todos los futuros
    if (g.isUpcoming) {
      return true;
    }
    // Descartar los dem√°s
    return false;
  });

// SEPARAR: Resultados vs Pr√≥ximos
const rawResults = processedGames.filter((g: any) => g.hasResult);
const rawUpcoming = processedGames.filter((g: any) => g.isUpcoming);

/**
 * Obtiene el pr√≥ximo partido real de cada categor√≠a
 * Usa Map para garantizar unicidad y selecciona el primero de cada categor√≠a
 */
function getNextMatchPerCategory(games: any[]): any[] {
  const categoryMap = new Map();
  
  // Recorrer en orden (ya est√°n ordenados por fecha)
  for (const game of games) {
    if (!categoryMap.has(game.categoria)) {
      categoryMap.set(game.categoria, game);
    }
  }
  
  return Array.from(categoryMap.values());
}

/**
 * Obtiene el √∫ltimo resultado de cada categor√≠a
 */
function getLatestResultPerCategory(games: any[]): any[] {
  const categoryMap = new Map();
  
  // Recorrer en orden inverso para obtener el m√°s reciente
  for (let i = games.length - 1; i >= 0; i--) {
    const game = games[i];
    if (!categoryMap.has(game.categoria)) {
      categoryMap.set(game.categoria, game);
    }
  }
  
  return Array.from(categoryMap.values());
}

// FILTRO UNICIDAD Y ORDENACI√ìN
const sortedResults = rawResults
  .sort((a: any, b: any) => (b.gameDateTimeSort?.getTime() || 0) - (a.gameDateTimeSort?.getTime() || 0));

const lastResults = getLatestResultPerCategory(sortedResults);

const sortedUpcoming = rawUpcoming
  .sort((a: any, b: any) => (a.gameDateTimeSort?.getTime() || 0) - (b.gameDateTimeSort?.getTime() || 0));

const upcomingGames = getNextMatchPerCategory(sortedUpcoming);
---

<html lang="es">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>ADESA 80 - Premium Basketball Club</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
		<style is:inline>
			* {
				font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
			}
			
			body {
				background: white;
				color: #1e293b;
			}
			
			h1, h2, h3 {
				color: #0f172a;
				letter-spacing: -0.02em;
			}
			
			/* Smooth scrolling */
			html {
				scroll-behavior: smooth;
			}
		</style>
	</head>
	<body class="bg-white text-slate-900">
		<!-- Sticky Navigation Bar -->
		<nav class="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-md border-b border-gray-100">
			<div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
				<!-- Logo -->
			<div class="shrink-0">
				</div>
				
				<!-- Nav Links -->
				<div class="hidden md:flex items-center gap-8">
					<a href="#inicio" class="text-slate-600 hover:text-slate-900 font-medium transition-colors">Inicio</a>
					<a href="#noticias" class="text-slate-600 hover:text-slate-900 font-medium transition-colors">Noticias</a>
					<a href="#resultados" class="text-slate-600 hover:text-slate-900 font-medium transition-colors">Partidos</a>
					<a href="#club" class="text-slate-600 hover:text-slate-900 font-medium transition-colors">Club</a>
					<a href="#escuelas" class="text-slate-600 hover:text-slate-900 font-medium transition-colors">Escuelas</a>
				</div>
				
				<!-- CTA Button -->
				<button class="hidden md:inline-block bg-green-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-green-700 transition-colors">
					Tienda
				</button>
			</div>
		</nav>

		<!-- Hero Section -->
	<section id="inicio" class="pt-32 pb-24 px-6 bg-linear-to-b from-gray-50 to-white">
			<div class="max-w-7xl mx-auto text-center">
				<!-- Main Title -->
				<h1 class="text-7xl md:text-8xl font-extrabold tracking-tight mb-6 text-slate-900">
					ADESA 80
				</h1>
				
				<!-- Subtitle -->
				<p class="text-2xl md:text-3xl text-slate-600 font-light mb-12 max-w-2xl mx-auto">
					M√°s que un club, una familia.
				</p>
				
				<!-- CTA Buttons -->
				<div class="flex flex-col sm:flex-row items-center justify-center gap-4">
					<a href="#resultados" class="px-8 py-4 bg-green-600 text-white rounded-full font-semibold text-lg hover:bg-green-700 transition-all hover:shadow-lg">
						Ver Resultados
					</a>
					<button class="px-8 py-4 bg-gray-100 text-slate-900 rounded-full font-semibold text-lg hover:bg-gray-200 transition-all">
						Tienda
					</button>
				</div>
			</div>
		</section>

		<!-- Carousel: Pr√≥ximos Partidos -->
		{upcomingGames && upcomingGames.length > 0 && (
			<section class="px-6 py-20 bg-white">
				<div class="max-w-7xl mx-auto">
					<h2 class="text-5xl font-extrabold tracking-tight mb-10 text-slate-900">Pr√≥ximos Partidos</h2>
					
					<!-- Carousel Container with Controls -->
					<div class="carousel-wrapper relative">
						<!-- Left Arrow -->
						<button class="carousel-nav carousel-nav-prev absolute left-0 top-1/2 -translate-y-1/2 -translate-x-20 z-10 w-12 h-12 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center hover:border-slate-900 transition-all duration-300" data-carousel="upcoming" aria-label="Previous">
							<svg class="w-5 h-5 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
							</svg>
						</button>

						<div class="upcoming-carousel overflow-x-auto scrollbar-hide scroll-smooth">
							<div class="flex gap-6 pb-6">
								{upcomingGames.map((game, idx) => {
									return (
										<div class="shrink-0">
											<div class="w-full md:w-[520px] bg-white rounded-[2.5rem] p-8 border border-gray-200 transition-all duration-300 cursor-pointer carousel-card flex flex-col justify-center gap-6" data-index={idx}>
												<!-- Categor√≠a badge en el centro superior -->
												<div class="flex justify-center mb-2">
													<span class="text-[10px] font-bold uppercase tracking-widest text-gray-400 bg-gray-100 px-3 py-1 rounded-full">
														{game.categoria}
													</span>
												</div>

												<!-- Horizontal Match Row: [Local] ‚Äî [Fecha/Hora] ‚Äî [Visitante] -->
												<div class="flex items-center justify-between w-full gap-3">
													<!-- Local Team (Right-aligned) -->
													<div class="flex-1 text-right pr-2">
														<h3 class="text-sm font-bold text-slate-900 line-clamp-2 leading-tight">{game.local}</h3>
													</div>

													<!-- Center: Fecha y Hora en green box -->
													<div class="shrink-0 text-center px-4">
														<div class="bg-linear-to-br from-green-50 to-green-100 rounded-xl px-6 py-3 border-2 border-green-200">
															<p class="text-xs text-slate-400 font-semibold mb-2">
																{game.gameDate?.toLocaleDateString('es-ES')}
															</p>
															{game.hora && (
																<p class="text-2xl font-extrabold text-green-700">{game.hora}</p>
															)}
														</div>
													</div>

													<!-- Visitor Team (Left-aligned) -->
													<div class="flex-1 text-left pl-2">
														<h3 class="text-sm font-bold text-slate-900 line-clamp-2 leading-tight">{game.visitante}</h3>
													</div>
												</div>

												<!-- Bottom: Pabell√≥n si existe -->
												<div class="text-center text-xs text-slate-500 border-t border-gray-200 pt-4">
													{game.pabellon && game.pabellon !== 'N/A' && (
														<p class="font-medium">üìç {game.pabellon}</p>
													)}
												</div>
											</div>
										</div>
									);
								})}
							</div>
						</div>

						<!-- Right Arrow -->
						<button class="carousel-nav carousel-nav-next absolute right-0 top-1/2 -translate-y-1/2 translate-x-20 z-10 w-12 h-12 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center hover:border-slate-900 transition-all duration-300" data-carousel="upcoming" aria-label="Next">
							<svg class="w-5 h-5 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
							</svg>
						</button>
					</div>

					<!-- Carousel Indicators -->
					{upcomingGames.length > 1 && (
						<div class="flex justify-center gap-2 mt-10">
							{upcomingGames.map((_, idx) => (
								<button class="carousel-indicator h-1 w-8 rounded-full bg-gray-300 transition-all duration-300 hover:w-10 cursor-pointer" data-index={idx} data-carousel="upcoming" aria-label={`Go to match ${idx + 1}`}></button>
							))}
						</div>
					)}
				</div>
			</section>
		)}

		<!-- Carousel: √öltimos Resultados -->
		<section id="resultados" class="px-6 py-20 bg-white">
			<div class="max-w-7xl mx-auto">
				<h2 class="text-5xl font-extrabold tracking-tight mb-10 text-slate-900">√öltimos Resultados</h2>
				
				{lastResults && lastResults.length > 0 ? (
					<>
						<!-- Carousel Container with Controls -->
						<div class="carousel-wrapper relative">
							<!-- Left Arrow -->
							<button class="carousel-nav carousel-nav-prev absolute left-0 top-1/2 -translate-y-1/2 -translate-x-20 z-10 w-12 h-12 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center hover:border-slate-900 transition-all duration-300" data-carousel="results" aria-label="Previous">
								<svg class="w-5 h-5 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
								</svg>
							</button>

							<div class="results-carousel overflow-x-auto scrollbar-hide scroll-smooth">
								<div class="flex gap-6 pb-6">
									{lastResults.map((result, idx) => {
										// Datos del partido
										const localPts = result.marcadorLocal;
										const visitorPts = result.marcadorVisitante;
										const isAdesaWinner = result.isAdesaLocal 
											? (localPts && visitorPts && parseInt(localPts) > parseInt(visitorPts))
											: (localPts && visitorPts && parseInt(visitorPts) > parseInt(localPts));
										
										return (
											<div class="shrink-0">
												<div class="w-full md:w-[520px] bg-white rounded-[2.5rem] p-8 border border-gray-200 transition-all duration-300 cursor-pointer carousel-card flex flex-col justify-center gap-6" data-index={idx}>
													<!-- Categor√≠a badge en el centro superior -->
													<div class="flex justify-center mb-2">
														<span class="text-[10px] font-bold uppercase tracking-widest text-gray-400 bg-gray-100 px-3 py-1 rounded-full">
															{result.categoria}
														</span>
													</div>

													<!-- Horizontal Match Row: [Local] ‚Äî [Marcador] ‚Äî [Visitante] -->
													<div class="flex items-center justify-between w-full gap-3">
														<!-- Local Team (Right-aligned) -->
														<div class="flex-1 text-right pr-2">
															<h3 class="text-sm font-bold text-slate-900 line-clamp-2 leading-tight">{result.local}</h3>
														</div>

														<!-- Center: Fecha y Marcador en green box -->
														<div class="shrink-0 text-center px-4">
															<div class="bg-linear-to-br from-green-50 to-green-100 rounded-xl px-6 py-3 border-2 border-green-200">
																<p class="text-xs text-slate-400 font-semibold mb-2">
																	{result.gameDate?.toLocaleDateString('es-ES')}
																</p>
																{localPts && visitorPts ? (
																	<div class="flex items-center justify-center gap-2">
																		<p class="text-2xl font-extrabold text-slate-900">{localPts}</p>
																		<p class="text-slate-400 text-lg font-light">-</p>
																		<p class="text-2xl font-extrabold text-slate-900">{visitorPts}</p>
																	</div>
																) : (
																	<p class="text-xs text-slate-400 font-medium">Sin resultado</p>
																)}
															</div>
															{isAdesaWinner && (
																<div class="mt-2">
																	<span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full font-bold text-xs">
																		<span class="w-1.5 h-1.5 bg-green-600 rounded-full"></span>
																		VICTORIA
																	</span>
																</div>
															)}
														</div>

														<!-- Visitor Team (Left-aligned) -->
														<div class="flex-1 text-left pl-2">
															<h3 class="text-sm font-bold text-slate-900 line-clamp-2 leading-tight">{result.visitante}</h3>
														</div>
													</div>

													<!-- Bottom: Pabell√≥n si existe -->
													<div class="text-center text-xs text-slate-500 border-t border-gray-200 pt-4">
														{result.pabellon && result.pabellon !== 'N/A' && (
															<p class="font-medium">üìç {result.pabellon}</p>
														)}
													</div>
												</div>
											</div>
										);
									})}
								</div>
							</div>

							<!-- Right Arrow -->
							<button class="carousel-nav carousel-nav-next absolute right-0 top-1/2 -translate-y-1/2 translate-x-20 z-10 w-12 h-12 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center hover:border-slate-900 transition-all duration-300" data-carousel="results" aria-label="Next">
								<svg class="w-5 h-5 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
								</svg>
							</button>
						</div>

						<!-- Carousel Indicators -->
						{lastResults.length > 1 && (
							<div class="flex justify-center gap-2 mt-10">
								{lastResults.map((_, idx) => (
									<button class="carousel-indicator h-1 w-8 rounded-full bg-gray-300 transition-all duration-300 hover:w-10 cursor-pointer" data-index={idx} data-carousel="results" aria-label={`Go to match ${idx + 1}`}></button>
								))}
							</div>
						)}
					</>
				) : (
					<div class="bg-white rounded-[2.5rem] p-12 text-center border border-gray-200">
						<p class="text-slate-500 text-lg font-medium">No hay resultados disponibles</p>
					</div>
				)}
			</div>
		</section>

		<!-- Sponsors Section -->
		<section id="sponsors" class="px-6 py-20 bg-white">
			<div class="max-w-7xl mx-auto">
				<h2 class="text-3xl font-extrabold tracking-tight mb-12 text-slate-900 text-center">Patrocinadores</h2>
				
				<div class="flex flex-wrap items-center justify-center gap-12">
					{['Sponsor 1', 'Sponsor 2', 'Sponsor 3', 'Sponsor 4'].map((sponsor) => (
						<div class="grayscale opacity-40 hover:grayscale-0 hover:opacity-100 transition-all duration-300 cursor-pointer">
							<div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center">
								<p class="text-sm font-semibold text-gray-600 text-center">{sponsor}</p>
							</div>
						</div>
					))}
				</div>
			</div>
		</section>

		<!-- Footer -->
		<footer class="border-t border-gray-100 bg-gray-50 py-12 px-6">
			<div class="max-w-7xl mx-auto text-center">
				<p class="text-slate-600 font-medium mb-2">ADESA 80 ‚Ä¢ Federaci√≥n Andaluza de Baloncesto</p>
				<p class="text-slate-400 text-sm">¬© 2026. Todos los derechos reservados.</p>
			</div>
		</footer>

		<script>
			// Advanced Carousel Controller con l√≥gica robusta de fechas
			function initCarousel(carouselSelector: string, indicatorSelector: string, navSelector: string) {
				const carousel = document.querySelector(carouselSelector) as HTMLElement;
				const indicators = document.querySelectorAll(indicatorSelector);
				const navButtons = document.querySelectorAll(navSelector);
				
				if (!carousel || indicators.length === 0) return;

				let currentIndex = 0;
				let autoRotationId: ReturnType<typeof setInterval> | null = null;
				const cardWidth = 520;
				const gap = 24;
				const totalWidth = cardWidth + gap;
				const ROTATION_INTERVAL = 5000; // 5 segundos
				const RESUME_TIMEOUT = 10000; // 10 segundos

				/**
				 * Desplaza el carrusel al √≠ndice especificado
				 */
				function scrollToCard(index: number): void {
					if (!carousel) return;
					
					const scrollPosition = index * totalWidth;
					carousel.scrollTo({
						left: scrollPosition,
						behavior: 'smooth'
					});

					// Actualizar indicadores
					indicators.forEach((indicator, idx) => {
						if (idx === index) {
							indicator.classList.add('carousel-active');
						} else {
							indicator.classList.remove('carousel-active');
						}
					});

					currentIndex = index;
				}

				/**
				 * Inicia la rotaci√≥n autom√°tica
				 */
				function startAutoRotation(): void {
					if (autoRotationId) clearInterval(autoRotationId);
					
					autoRotationId = setInterval(() => {
						currentIndex = (currentIndex + 1) % indicators.length;
						scrollToCard(currentIndex);
					}, ROTATION_INTERVAL);
				}

				/**
				 * Detiene la rotaci√≥n autom√°tica
				 */
				function stopAutoRotation(): void {
					if (autoRotationId) {
						clearInterval(autoRotationId);
						autoRotationId = null;
					}
				}

				/**
				 * Reanuda la rotaci√≥n despu√©s de 10 segundos de inactividad
				 */
				function resumeAutoRotation(): void {
					stopAutoRotation();
					setTimeout(startAutoRotation, RESUME_TIMEOUT);
				}

				// Event listeners para indicadores
				indicators.forEach((indicator) => {
					indicator.addEventListener('click', (e: Event) => {
						const target = e.currentTarget as HTMLElement;
						const indexStr = target.getAttribute('data-index');
						const index = parseInt(indexStr || '0', 10);
						
						if (!isNaN(index) && index >= 0 && index < indicators.length) {
							scrollToCard(index);
							resumeAutoRotation();
						}
					});
				});

				// Event listeners para flechas de navegaci√≥n
				navButtons.forEach((btn) => {
					btn.addEventListener('click', () => {
						const direction = (btn as HTMLElement).classList.contains('carousel-nav-prev') ? -1 : 1;
						currentIndex = (currentIndex + direction + indicators.length) % indicators.length;
						scrollToCard(currentIndex);
						resumeAutoRotation();
					});
				});

				// Pausar en interacci√≥n del usuario, reanudar despu√©s
				carousel.addEventListener('mousedown', stopAutoRotation);
				carousel.addEventListener('touchstart', stopAutoRotation);
				carousel.addEventListener('mouseup', resumeAutoRotation);
				carousel.addEventListener('touchend', resumeAutoRotation);
				carousel.addEventListener('mouseleave', resumeAutoRotation);

				// Estado inicial
				scrollToCard(0);
				startAutoRotation();
			}

			// Inicializar ambos carruseles
			initCarousel(
				'.upcoming-carousel',
				'.carousel-indicator[data-carousel="upcoming"]',
				'.carousel-nav[data-carousel="upcoming"]'
			);
			initCarousel(
				'.results-carousel',
				'.carousel-indicator[data-carousel="results"]',
				'.carousel-nav[data-carousel="results"]'
			);
		</script>
	</body>
</html>
