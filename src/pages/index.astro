---
import Layout from '../layouts/Layout.astro';

// Importar todos los archivos JSON de equipos
import seniorMasculinoA from '../data/equipos/senior-masculino-a.json';
import juniorMasculinoA from '../data/equipos/junior-masculino-a.json';
import juniorMasculinoB from '../data/equipos/junior-masculino-b.json';
import cadeteFemeninoA from '../data/equipos/cadete-femenino-a.json';
import cadeteFemeninoB from '../data/equipos/cadete-femenino-b.json';
import cadeteMasculinoA from '../data/equipos/cadete-masculino-a.json';
import cadeteMixtoB from '../data/equipos/cadete-mixto-b.json';
import infantilMasculinoA from '../data/equipos/infantil-masculino-a.json';
import infantilFemeninoA from '../data/equipos/infantil-femenino-a.json';
import infantilMixtoB from '../data/equipos/infantil-mixto-b.json';
import infantilMixto from '../data/equipos/infantil-mixto.json';
import minibasketFemeninoA from '../data/equipos/minibasket-femenino-a.json';
import minibasketFemenino from '../data/equipos/minibasket-femenino.json';
import minibasketMasculinoA from '../data/equipos/minibasket-masculino-a.json';
import minibasketMixtoB from '../data/equipos/minibasket-mixto-b.json';
import preminiFemenino from '../data/equipos/premini-femenino.json';
import preminiMixto from '../data/equipos/premini-mixto.json';
import babybasketMixto from '../data/equipos/babybasket-mixto.json';

// Combinar todos los partidos en un solo array
const partidos = [
  ...seniorMasculinoA,
  ...juniorMasculinoA,
  ...juniorMasculinoB,
  ...cadeteFemeninoA,
  ...cadeteFemeninoB,
  ...cadeteMasculinoA,
  ...cadeteMixtoB,
  ...infantilMasculinoA,
  ...infantilFemeninoA,
  ...infantilMixtoB,
  ...infantilMixto,
  ...minibasketFemeninoA,
  ...minibasketFemenino,
  ...minibasketMasculinoA,
  ...minibasketMixtoB,
  ...preminiFemenino,
  ...preminiMixto,
  ...babybasketMixto
];

// Funci√≥n para parsear fecha DD/MM/YYYY y hora HH:MM
function parseFechaHora(fechaStr: string, horaStr: string): Date {
  const [dia, mes, anio] = fechaStr.split('/').map(Number);
  const fecha = new Date(anio, mes - 1, dia);
  
  if (horaStr && horaStr.includes(':')) {
    const [horas, minutos] = horaStr.split(':').map(Number);
    fecha.setHours(horas, minutos, 0, 0);
  } else {
    fecha.setHours(23, 59, 59, 999); // Si no hay hora, asumimos final del d√≠a
  }
  
  return fecha;
}

// Jerarqu√≠a de categor√≠as para ordenaci√≥n
const jerarquiaCategorias: any = {
  'Senior': 6,
  'Junior': 5,
  'Cadete': 4,
  'Infantil': 3,
  'Minibasket': 2,
  'PreMini': 1,
  'Babybasket': 0,
  'Baby': 0
};

function getNivelCategoria(equipo: string): number {
  for (const nivel in jerarquiaCategorias) {
    if (equipo.includes(nivel)) {
      return jerarquiaCategorias[nivel];
    }
  }
  return 0;
}

function esGeneroMasculino(equipo: string): boolean {
  return equipo.toLowerCase().includes('masculino');
}

// Funci√≥n de ordenaci√≥n con criterios de prioridad
function ordenarPartidos(a: any, b: any, ascendente = true): number {
  const fechaA = parseFechaHora(a.fecha, a.hora || '');
  const fechaB = parseFechaHora(b.fecha, b.hora || '');
  
  // 1. Por fecha y hora
  const difTiempo = ascendente 
    ? fechaA.getTime() - fechaB.getTime()
    : fechaB.getTime() - fechaA.getTime();
  
  if (difTiempo !== 0) return difTiempo;
  
  // 2. Por local√≠a (Local primero)
  if (a.ubicacion === 'Local' && b.ubicacion !== 'Local') return -1;
  if (a.ubicacion !== 'Local' && b.ubicacion === 'Local') return 1;
  
  // 3. Por nivel de categor√≠a
  const nivelA = getNivelCategoria(a.equipo || '');
  const nivelB = getNivelCategoria(b.equipo || '');
  if (nivelA !== nivelB) return nivelB - nivelA;
  
  // 4. Por g√©nero (Masculino primero)
  const mascA = esGeneroMasculino(a.equipo || '');
  const mascB = esGeneroMasculino(b.equipo || '');
  if (mascA && !mascB) return -1;
  if (!mascA && mascB) return 1;
  
  return 0;
}

// Momento actual
const ahora = new Date();

// Filtrar por tiempo real (no por campo es_resultado)
const proximosPartidos = partidos
  .filter((p: any) => {
    const fechaPartido = parseFechaHora(p.fecha, p.hora || '');
    return fechaPartido >= ahora;
  })
  .sort((a: any, b: any) => ordenarPartidos(a, b, true));

const resultadosPasados = partidos
  .filter((p: any) => {
    const fechaPartido = parseFechaHora(p.fecha, p.hora || '');
    return fechaPartido < ahora;
  })
  .sort((a: any, b: any) => ordenarPartidos(a, b, false));

// Obtener lista √∫nica de todos los equipos (manteniendo el orden de prioridad)
const todosLosEquipos = [
  ...seniorMasculinoA,
  ...juniorMasculinoA,
  ...juniorMasculinoB,
  ...cadeteFemeninoA,
  ...cadeteFemeninoB,
  ...cadeteMasculinoA,
  ...cadeteMixtoB,
  ...infantilMasculinoA,
  ...infantilFemeninoA,
  ...infantilMixtoB,
  ...infantilMixto,
  ...minibasketFemeninoA,
  ...minibasketFemenino,
  ...minibasketMasculinoA,
  ...minibasketMixtoB,
  ...preminiFemenino,
  ...preminiMixto,
  ...babybasketMixto
];

const equiposUnicos: string[] = [];
const equiposSet = new Set();

for (const partido of todosLosEquipos) {
  if (!equiposSet.has(partido.equipo)) {
    equiposUnicos.push(partido.equipo);
    equiposSet.add(partido.equipo);
  }
}

// Crear arrays sincronizados: para cada equipo, obtener su pr√≥ximo partido y √∫ltimo resultado
const proximosPartidosPorEquipo: any[] = [];
const resultadosPorEquipo: any[] = [];

for (const equipo of equiposUnicos) {
  const proximoDelEquipo = proximosPartidos.find((p: any) => p.equipo === equipo);
  const resultadoDelEquipo = resultadosPasados.find((p: any) => p.equipo === equipo);
  
  // Solo incluir equipos que tengan AMBOS: pr√≥ximo partido Y √∫ltimo resultado
  if (proximoDelEquipo && resultadoDelEquipo) {
    proximosPartidosPorEquipo.push(proximoDelEquipo);
    resultadosPorEquipo.push(resultadoDelEquipo);
  }
}

const proximoPartido: any = proximosPartidos[0];
const ultimoResultado: any = resultadosPasados[0];
---

<Layout title="ADESA 80 - Club de Baloncesto">
  <!-- Hero Section -->
  <section class="relative bg-white overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 sm:py-32">
      <div class="text-center">
        <h1 class="text-5xl sm:text-7xl font-black text-gray-900 mb-6 tracking-tight">
          ADESA 80
        </h1>
        
        <p class="text-xl sm:text-2xl text-gray-600 mb-12 max-w-3xl mx-auto font-light">
          Pasi√≥n, compromiso y excelencia en cada cancha
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a 
            href="/partidos" 
            class="inline-flex items-center justify-center px-8 py-4 bg-adesa-green text-white font-semibold rounded-2xl hover:bg-adesa-dark transition-all shadow-lg hover:shadow-xl hover:scale-105"
          >
            Ver Partidos
          </a>
          <a 
            href="/club" 
            class="inline-flex items-center justify-center px-8 py-4 bg-white text-gray-900 font-semibold rounded-2xl border-2 border-gray-200 hover:border-adesa-green transition-all"
          >
            Conoce el Club
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Bento Grid -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- Pr√≥ximo Partido - Carrusel (2 columnas) -->
      <div class="lg:col-span-2 relative">
        <div id="carousel-proximos" class="relative">
          {proximosPartidosPorEquipo.map((proximoPartido: any, index: number) => (
            <div 
              class={`carousel-item ${index === 0 ? 'active' : ''}`} 
              data-index={index}
              style={index === 0 ? '' : 'display: none;'}
            >
              <div class="bg-linear-to-br from-adesa-green to-adesa-dark rounded-3xl p-8 text-white shadow-lg hover:shadow-2xl" style="min-height: 300px; display: grid; grid-template-rows: auto 1fr auto; transition: box-shadow 0.3s ease-in-out;">
                <div class="flex items-center justify-between mb-6">
                  <span class="text-sm font-bold truncate max-w-[60%]">{proximoPartido.equipo}</span>
                  <span class="text-sm font-semibold whitespace-nowrap">{proximoPartido.fecha}</span>
                </div>
                
                <div class="flex items-center justify-center">
                  <div class="w-full" style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;">
                    <div class="flex flex-col items-center justify-center gap-2">
                      <p class="text-center text-base font-extrabold break-words leading-tight">
                        {proximoPartido.ubicacion === 'Local' ? 'ADESA 80' : proximoPartido.rival}
                      </p>
                    </div>
                    
                    <div class="flex items-center justify-center shrink-0 px-8">
                      <p class="text-2xl font-black opacity-80">VS</p>
                    </div>
                    
                    <div class="flex flex-col items-center justify-center gap-2">
                      <p class="text-center text-base font-extrabold break-words leading-tight">
                        {proximoPartido.ubicacion === 'Local' ? proximoPartido.rival : 'ADESA 80'}
                      </p>
                    </div>
                  </div>
                </div>
                
                <div class="flex items-center justify-between text-sm border-t border-white/20 pt-4 mt-4">
                  <span class="whitespace-nowrap">{proximoPartido.hora || 'Por definir'}</span>
                  <a 
                    href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                      proximoPartido.pabellon.toLowerCase().includes('municipal') || proximoPartido.pabellon.toLowerCase().includes('pdvo. municipal')
                        ? 'Polideportivo Municipal Sanl√∫car de Barrameda, C√°diz'
                        : proximoPartido.pabellon + ' Sanl√∫car de Barrameda, C√°diz'
                    )}`}
                    target="_blank"
                    class="hover:underline text-right truncate max-w-[60%] ml-2"
                  >
                    üìç {proximoPartido.pabellon}
                  </a>
                </div>
                
                <div class="mt-4">
                  <a href="/partidos" class="block text-center px-4 py-2 bg-white text-adesa-green font-semibold rounded-xl hover:bg-green-50 transition-all">
                    Ver Calendario Completo
                  </a>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- √öltimo Resultado - Carrusel -->
      <div class="relative">
        <div id="carousel-resultados" class="relative">
          {resultadosPorEquipo.map((ultimoResultado: any, index: number) => {
            const esAdesaLocal = ultimoResultado.ubicacion === 'Local';
            const nombreLocal = esAdesaLocal ? 'ADESA 80' : ultimoResultado.rival;
            const nombreVisitante = esAdesaLocal ? ultimoResultado.rival : 'ADESA 80';
            const puntosLocal = parseInt(ultimoResultado.marcador_local || '0');
            const puntosVisitante = parseInt(ultimoResultado.marcador_visitante || '0');
            const puntosAdesa = esAdesaLocal ? puntosLocal : puntosVisitante;
            const puntosRival = esAdesaLocal ? puntosVisitante : puntosLocal;
            
            // Determinar si es empate 0-0 o contra DESCANSA
            const esEmpate00 = puntosLocal === 0 && puntosVisitante === 0;
            const contraDescansa = ultimoResultado.rival?.toUpperCase().includes('DESCANSA');
            const borderGris = esEmpate00 || contraDescansa;
            
            const haGanadoAdesa = ultimoResultado.marcador_local && 
                                  ultimoResultado.marcador_visitante && 
                                  puntosAdesa > puntosRival;
            
            return (
              <div 
                class={`carousel-item ${index === 0 ? 'active' : ''}`} 
                data-index={index}
                style={index === 0 ? '' : 'display: none;'}
              >
                <div class={`bg-white rounded-3xl p-6 shadow-lg hover:shadow-2xl border-2 ${
                  borderGris ? 'border-gray-400' : (haGanadoAdesa ? 'border-adesa-green' : 'border-red-500')
                }`} style="min-height: 300px; display: grid; grid-template-rows: auto 1fr auto; transition: box-shadow 0.3s ease-in-out;">
                  
                  <div class="flex items-center justify-between mb-6">
                    <span class="font-bold text-gray-800 text-xs truncate max-w-[55%]">{ultimoResultado.equipo}</span>
                    <span class="text-xs text-gray-600 font-medium whitespace-nowrap">{ultimoResultado.fecha}</span>
                  </div>
                  
                  <div class="flex items-center justify-center">
                    <div class="w-full" style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 1rem;">
                      
                      <div class="flex flex-col items-center justify-center gap-3">
                        <p class="text-center text-sm font-extrabold text-gray-900 break-words leading-tight">
                          {nombreLocal}
                        </p>
                        {ultimoResultado.marcador_local && ultimoResultado.marcador_visitante && (
                          <p class={`text-4xl ${
                            esAdesaLocal
                              ? (puntosAdesa > puntosRival ? 'font-extrabold text-adesa-green' : 'font-black text-gray-400')
                              : 'font-black text-gray-900'
                          }`}>
                            {ultimoResultado.marcador_local}
                          </p>
                        )}
                      </div>
                      
                      <div class="flex items-center justify-center shrink-0 px-4">
                        <p class="text-lg font-black text-gray-400">VS</p>
                      </div>
                      
                      <div class="flex flex-col items-center justify-center gap-3">
                        <p class="text-center text-sm font-extrabold text-gray-900 break-words leading-tight">
                          {nombreVisitante}
                        </p>
                        {ultimoResultado.marcador_local && ultimoResultado.marcador_visitante && (
                          <p class={`text-4xl ${
                            !esAdesaLocal
                              ? (puntosAdesa > puntosRival ? 'font-extrabold text-adesa-green' : 'font-black text-gray-400')
                              : 'font-black text-gray-900'
                          }`}>
                            {ultimoResultado.marcador_visitante}
                          </p>
                        )}
                      </div>
                      
                    </div>
                  </div>
                  
                  <div class="flex items-center justify-between text-xs text-gray-600 border-t border-gray-100 pt-3 mt-3">
                    <span class="whitespace-nowrap">{ultimoResultado.hora || 'Por definir'}</span>
                    <a 
                      href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                        ultimoResultado.pabellon.toLowerCase().includes('municipal') || ultimoResultado.pabellon.toLowerCase().includes('pdvo. municipal')
                          ? 'Polideportivo Municipal Sanl√∫car de Barrameda, C√°diz'
                          : ultimoResultado.pabellon + ' Sanl√∫car de Barrameda, C√°diz'
                      )}`}
                      target="_blank"
                      class="hover:underline text-right truncate max-w-[55%] ml-2"
                    >
                      üìç {ultimoResultado.pabellon}
                    </a>
                  </div>
                  
                  <a href="/partidos" class="block text-center mt-4 text-adesa-green text-sm font-medium hover:text-adesa-dark transition-colors">
                    Ver Todos los Resultados ‚Üí
                  </a>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      <!-- Tienda -->
      <div class="bg-gray-900 rounded-3xl p-8 text-white shadow-lg hover:shadow-2xl overflow-hidden relative" style="transition: box-shadow 0.3s ease-in-out;">
        <div class="relative z-10">
          <h2 class="text-xl font-bold mb-3">Equipaci√≥n Oficial</h2>
          <p class="text-gray-300 mb-6 text-sm">Consigue la camiseta oficial del ADESA 80</p>
          <a 
            href="/tienda" 
            class="inline-block px-6 py-3 bg-adesa-green text-white font-semibold rounded-xl hover:bg-white hover:text-adesa-green transition-all"
          >
            Visitar Tienda
          </a>
        </div>
        <div class="absolute -bottom-4 -right-4 text-9xl opacity-10">üëï</div>
      </div>

      <!-- Campus -->
      <div class="bg-linear-to-br from-adesa-green/10 to-adesa-dark/10 rounded-3xl p-8 border-2 border-adesa-green/20 hover:border-adesa-green shadow-lg hover:shadow-2xl" style="transition: all 0.3s ease-in-out;">
        <h2 class="text-xl font-bold text-gray-900 mb-3">Campus de Verano</h2>
        <p class="text-gray-600 mb-6 text-sm">Inscripciones abiertas para la pr√≥xima temporada</p>
        <a 
          href="/campus" 
          class="inline-block px-6 py-3 bg-adesa-green text-white font-semibold rounded-xl hover:bg-adesa-dark transition-all"
        >
          M√°s Informaci√≥n
        </a>
      </div>

      <!-- Club -->
      <div class="bg-white rounded-3xl p-8 shadow-lg hover:shadow-2xl border-2 border-gray-100" style="transition: box-shadow 0.3s ease-in-out;">
        <h2 class="text-xl font-bold text-gray-900 mb-3">Sobre ADESA 80</h2>
        <p class="text-gray-600 mb-6 text-sm">
          Descubre nuestra historia, valores y el equipo que hace posible este proyecto deportivo.
        </p>
        <a 
          href="/club" 
          class="inline-block text-adesa-green font-semibold hover:text-adesa-dark transition-colors"
        >
          Conocer M√°s ‚Üí
        </a>
      </div>

    </div>
  </section>

  <!-- Call to Action -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
    <div class="bg-linear-to-br from-adesa-dark to-adesa-green rounded-3xl p-12 text-center text-white shadow-2xl">
      <h2 class="text-3xl sm:text-4xl font-black mb-4">
        ¬øQuieres formar parte del equipo?
      </h2>
      <p class="text-xl text-green-50 mb-8 max-w-2xl mx-auto">
        √önete a la familia ADESA 80 y vive la pasi√≥n del baloncesto
      </p>
      <a 
        href="/club#contacto" 
        class="inline-block px-8 py-4 bg-white text-adesa-green font-bold rounded-2xl hover:bg-green-50 transition-all shadow-lg hover:shadow-xl hover:scale-105"
      >
        M√°s Informaci√≥n
      </a>
    </div>
  </section>

  <script>
    // Carrusel sincronizado para pr√≥ximos partidos y resultados
    let currentIndex = 0;
    const carouselProximos = document.getElementById('carousel-proximos');
    const carouselResultados = document.getElementById('carousel-resultados');
    
    if (carouselProximos && carouselResultados) {
      const itemsProximos = carouselProximos.querySelectorAll('.carousel-item');
      const itemsResultados = carouselResultados.querySelectorAll('.carousel-item');
      const totalItems = Math.max(itemsProximos.length, itemsResultados.length);
      
      function showSlide(index: number) {
        // Ocultar todos los items
        itemsProximos.forEach((item: Element) => {
          (item as HTMLElement).style.display = 'none';
          item.classList.remove('active');
        });
        itemsResultados.forEach((item: Element) => {
          (item as HTMLElement).style.display = 'none';
          item.classList.remove('active');
        });
        
        // Mostrar el item actual (con loop circular)
        const normalizedIndex = index % totalItems;
        
        if (itemsProximos[normalizedIndex]) {
          (itemsProximos[normalizedIndex] as HTMLElement).style.display = 'block';
          itemsProximos[normalizedIndex].classList.add('active');
        }
        
        if (itemsResultados[normalizedIndex]) {
          (itemsResultados[normalizedIndex] as HTMLElement).style.display = 'block';
          itemsResultados[normalizedIndex].classList.add('active');
        }
      }
      
      function nextSlide() {
        currentIndex = (currentIndex + 1) % totalItems;
        showSlide(currentIndex);
      }
      
      // Cambiar cada 5 segundos
      setInterval(nextSlide, 5000);
      
      // Mostrar el primer slide al cargar
      showSlide(0);
    }
  </script>
</Layout>
