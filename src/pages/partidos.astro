---
import Layout from '../layouts/Layout.astro';

// Derivar nombre humano del equipo desde categor√≠a + competici√≥n
function derivarNombreEquipo(categoria: string, competicion: string): string {
  const base = (categoria || '').split(' - ')[0].trim();
  const cl = (competicion || '').toLowerCase();
  if (cl.includes('copa andalucia a') || cl.includes('copa andaluc√≠a a')) return base + ' A';
  if (cl.includes('copa andalucia b') || cl.includes('copa andaluc√≠a b')) return base + ' B';
  return base;
}

// Helper de temporada
function getTemporada(fechaStr: string): string {
  const [d, m, y] = fechaStr.split('/').map(Number);
  if (m >= 9) return `${y % 100}/${(y + 1) % 100}`;
  return `${(y - 1) % 100}/${y % 100}`;
}

// Momento actual
const ahora = new Date();

// ========== DATOS DE LIGA (Panel de detalle por categor√≠a) ==========
const todosArchivos = import.meta.glob('../data/**/*.json', { eager: true }) as Record<string, any>;
const clasificacionesPorCat: Record<string, any> = {};
const partidosPorCat: Record<string, any[]> = {};

for (const [ruta, mod] of Object.entries(todosArchivos)) {
  if (ruta.includes('/equipos/') || ruta.endsWith('/partidos.json')) continue;
  if (ruta.toLowerCase().includes('liga-verano')) continue;
  const datos = (mod as any).default || mod;
  if (ruta.endsWith('/clasificacion.json') && datos?.categoria) {
    clasificacionesPorCat[datos.categoria] = datos;
  } else if (Array.isArray(datos) && datos.length > 0 && datos[0]?.categoria) {
    const cat = datos[0].categoria;
    if (!partidosPorCat[cat]) partidosPorCat[cat] = [];
    partidosPorCat[cat].push(...datos);
  }
}

// Solo categor√≠as con ADESA 80 (incluye variantes como "ADESA 80 (A)")
const catsAdesa = new Set(
  Object.entries(partidosPorCat)
    .filter(([_, m]) => m.some((p: any) => p.equipo === 'ADESA 80' || p.equipo?.includes('ADESA 80')))
    .map(([c]) => c)
);

// Agrupar partidos de ADESA 80 por equipo derivado (nombre humano)
const equiposMapa: Record<string, any[]> = {};
for (const cat of catsAdesa) {
  const matches = partidosPorCat[cat] || [];
  for (const m of matches) {
    if (m.equipo !== 'ADESA 80' && !m.equipo?.includes('ADESA 80')) continue;
    const teamName = derivarNombreEquipo(cat, m.competicion || '');
    if (!equiposMapa[teamName]) equiposMapa[teamName] = [];
    equiposMapa[teamName].push(m);
  }
}

// Construir ligaData por categor√≠a de competici√≥n
const ligaData: Record<string, any> = {};
for (const cat of catsAdesa) {
  const todos = partidosPorCat[cat] || [];
  const mapa = new Map<string, any>();
  for (const m of todos) {
    const clave = `${m.fecha}_${[m.equipo, m.rival].sort().join('_')}`;
    if (!mapa.has(clave) || m.ubicacion === 'Local') mapa.set(clave, m);
  }
  const jorMap = new Map<string, any[]>();
  for (const m of mapa.values()) {
    const j = m.jornada || 'Sin jornada';
    if (!jorMap.has(j)) jorMap.set(j, []);
    jorMap.get(j)!.push(m);
  }
  const jornadas = Array.from(jorMap.entries())
    .sort((a, b) => parseInt(a[0].match(/\d+/)?.[0] || '0') - parseInt(b[0].match(/\d+/)?.[0] || '0'))
    .map(([nombre, ms]) => ({
      n: nombre,
      p: ms.map(m => {
        const loc = m.ubicacion === 'Local';
        return {
          l: loc ? m.equipo : m.rival,
          v: loc ? m.rival : m.equipo,
          ml: m.marcador_local, mv: m.marcador_visitante,
          f: m.fecha, h: m.hora || '',
          a: m.equipo === 'ADESA 80' || m.rival === 'ADESA 80'
        };
      })
    }));
  ligaData[cat] = {
    c: clasificacionesPorCat[cat]?.clasificacion || [],
    j: jornadas,
    e: cat // se sobreescribir√° abajo con nombre amigable
  };
}

// Overview: 1 tarjeta por EQUIPO (agrupados por nombre derivado). Solo la liga activa.
const teamCards: Record<string, any> = {}; // key = teamName
for (const [teamName, eqData] of Object.entries(equiposMapa)) {
  if (!eqData || !eqData.length) continue;
  if (teamCards[teamName]) continue; // ya procesado
  // Categor√≠as del equipo (ya en formato de competici√≥n)
  const eqCats = [...new Set(eqData.map((p: any) => p.categoria as string))];
  const uniqueCompCats = eqCats.filter(cat => catsAdesa.has(cat));
  if (uniqueCompCats.length === 0) continue;
  // Categor√≠a activa: tiene partidos sin jugar. Preferir fase m√°s avanzada.
  const activeCats = uniqueCompCats.filter(cat => {
    const ms = partidosPorCat[cat] || [];
    return ms.some((p: any) => p.marcador_local === null || p.marcador_local === undefined || p.marcador_local === '');
  });
  if (activeCats.length === 0) continue; // Todas las ligas terminadas
  const phaseOrder = (s: string) => s.includes('FASE FINAL') ? 3 : s.includes('2¬™ FASE') ? 2 : 1;
  const activeCat = activeCats.sort((a, b) => phaseOrder(b) - phaseOrder(a))[0];
  // Actualizar nombre amigable en ligaData
  if (ligaData[activeCat]) ligaData[activeCat].e = teamName;
  const clasif = clasificacionesPorCat[activeCat]?.clasificacion || [];
  const row = clasif.find((x: any) => x.equipo === 'ADESA 80' || x.equipo?.includes('ADESA'));
  const activeMatches = partidosPorCat[activeCat] || [];
  const prox = activeMatches.filter((p: any) => {
    const [d,m,y] = p.fecha.split('/').map(Number);
    return new Date(y,m-1,d) >= ahora && (!p.marcador_local || p.marcador_local === '');
  }).sort((a: any, b: any) => {
    const [da,ma,ya] = a.fecha.split('/').map(Number);
    const [db,mb,yb] = b.fecha.split('/').map(Number);
    return new Date(ya,ma-1,da).getTime() - new Date(yb,mb-1,db).getTime();
  })[0];
  teamCards[teamName] = {
    nombre: teamName,
    cat: activeCat,
    pos: row?.posicion || null,
    total: clasif.length,
    pj: row?.partidos_jugados || 0,
    pg: row?.partidos_ganados || 0,
    pp: row?.partidos_perdidos || 0,
    pts: row?.puntos || 0,
    prox: prox ? { r: prox.rival, f: prox.fecha, u: prox.ubicacion } : null,
    temporada: activeMatches[0]?.fecha ? getTemporada(activeMatches[0].fecha) : '25/26'
  };
}
const equiposOverview = Object.values(teamCards).sort((a: any, b: any) => {
  const niv: any = {'Senior':6,'Junior':5,'Cadete':4,'Infantil':3,'Minibasket':2,'PreMini':1,'Babybasket':0};
  let na=0,nb=0;
  for (const n in niv) { if(a.nombre.includes(n))na=niv[n]; if(b.nombre.includes(n))nb=niv[n]; }
  return na !== nb ? nb - na : a.nombre.localeCompare(b.nombre);
});

// ========== WEEKLY VIEW DATA ==========
const weeklyTeamData = equiposOverview.map((eq: any) => {
  const catBase = eq.cat.split(' - ')[0].trim();
  const parts = catBase.split(' ');
  const nivel = parts[0];
  const genero = parts.length > 1 ? parts.slice(1).join(' ') : 'Mixto';
  const allMatches = (partidosPorCat[eq.cat] || [])
    .filter((m: any) => m.equipo === 'ADESA 80' || m.equipo?.includes('ADESA 80'))
    .map((m: any) => ({
      f: m.fecha, h: m.hora || '', r: m.rival, u: m.ubicacion,
      ml: m.marcador_local, mv: m.marcador_visitante,
    }));
  return {
    nombre: eq.nombre, cat: eq.cat, nivel, genero,
    pos: eq.pos, total: eq.total, pg: eq.pg, pp: eq.pp,
    temporada: eq.temporada, partidos: allMatches
  };
});

// ========== TEMPORADAS ==========
const currentMonth = ahora.getMonth() + 1;
const currentYear = ahora.getFullYear();
const currentSeason = currentMonth >= 9
  ? `${currentYear % 100}/${(currentYear + 1) % 100}`
  : `${(currentYear - 1) % 100}/${currentYear % 100}`;

const allSeasons = new Set<string>();
for (const [cat, matches] of Object.entries(partidosPorCat)) {
  if (!catsAdesa.has(cat)) continue;
  for (const m of matches) {
    allSeasons.add(getTemporada(m.fecha));
  }
}
const nextSeasonYear = currentMonth >= 9 ? currentYear + 1 : currentYear;
const nextSeason = `${nextSeasonYear % 100}/${(nextSeasonYear + 1) % 100}`;
allSeasons.add(nextSeason);
if (!allSeasons.has(currentSeason)) allSeasons.add(currentSeason);
const seasonsArr = Array.from(allSeasons).sort();

// ========== FASES/GRUPOS POR EQUIPO ==========
const teamPhases: Record<string, Array<{cat: string, phase: string, group: string, isActive: boolean}>> = {};
for (const [teamName, eqData] of Object.entries(equiposMapa)) {
  const eqCats = [...new Set(eqData.map((p: any) => p.categoria as string))];
  const options = eqCats.filter(c => catsAdesa.has(c)).map(cat => {
    const parts = cat.split(' - ');
    const phase = parts.length >= 2 ? parts[1].trim() : 'REGULAR';
    const group = parts.length >= 3 ? parts.slice(2).join(' - ').trim() : '√öNICO';
    const ms = partidosPorCat[cat] || [];
    const hasUnplayed = ms.some((p: any) => p.marcador_local === null || p.marcador_local === undefined || p.marcador_local === '');
    return { cat, phase, group, isActive: hasUnplayed };
  });
  const phaseOrd = (s: string) => s.includes('FASE FINAL') ? 3 : s.includes('2¬™ FASE') ? 2 : 1;
  options.sort((a, b) => phaseOrd(a.phase) - phaseOrd(b.phase) || a.group.localeCompare(b.group));
  teamPhases[teamName] = options;
}

const ligaDataJSON = JSON.stringify(ligaData);
const equiposOverviewJSON = JSON.stringify(equiposOverview);
const teamPhasesJSON = JSON.stringify(teamPhases);
const seasonsJSON = JSON.stringify(seasonsArr);
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');
const weeklyTeamDataJSON = JSON.stringify(weeklyTeamData);

// Logo map serializable for JS
const logoMapData = [
  [['ubjerez','ubj'], 'ubjerez.png'],
  [['gymnastica','gymn√°stica'], 'gymnastica.png'],
  [['portuense','cbp '], 'cbportuense.png'],
  [['cbsfdo','cb san fernando','san fernando'], 'cbsanfernando.png'],
  [['centurias'], 'sanroque.png'],
  [['adesa'], 'adesa80.png'],
  [['gades'], 'cbgades.png'],
  [['cbc c√°diz','cbc cadiz'], 'cbciudaddecadiz.png'],
  [['marianistas'], 'admarianistas.png'],
  [['mergablo'], 'cdmergablo.png'],
  [['chipiona'], 'chipionacb.png'],
  [['puerto real'], 'puertoreal.png'],
  [['medina'], 'cbmedinasidonia.png'],
  [['candray'], 'candray.png'],
  [['c.a.b.u','cabu','ubrique'], 'cabu.png'],
  [['cimbis'], 'cbcimbis.png'],
  [['urbaluz','uz red'], 'urbaluz.png'],
  [['san felipe','neri'], 'sanfelipeneri.png'],
  [['carteia'], 'ADCarteia.png'],
  [['udea'], 'cdudeaalgeciras.png'],
  [['algeciras'], 'cbalgeciras.png'],
  [['arcos'], 'arcos.png'],
  [['chiclana','ituci'], 'cbchiclana.png'],
  [['alcal√°','alcala','gazules'], 'alcaladelosgazules.png'],
  [['rota'], 'cbrota.png'],
  [['barrios'], 'losbarrios.png'],
  [['san roque'], 'sanroque.png'],
  [['don bosco'], 'cpdonbosco.png'],
  [['vejer'], 'ebmvejer.png'],
  [['xerez'], 'xerezcd.png'],
  [['ulb','linense'], 'ulblinense.png'],
  [['barbate'], 'cdbarbate.png'],
  [['prado'], 'cbpradodelrey.png'],
  [['sancti petri'], 'sanctipetri.png'],
  [['montera'], 'cdmergablo.png'],
  [['algaida'], 'adcalgaida.png'],
  [['gabba'], 'cbalgeciras.png'],
  [['trebujena'], 'cbtrebujena.svg'],
  [['inmaculada','ceuta'], 'cbinmaculadaceuta.svg'],
  [['cba'], 'cbalgeciras.png'],
  [['maxcolchon'], 'cbsanfernando.png'],
  [['ongolf'], 'sanroque.png'],
];
const logoMapJSON = JSON.stringify(logoMapData);
---

<Layout title="Partidos y Resultados - ADESA 80">
  <!-- ========== CATEGOR√çAS ========== -->
  <section id="zonaLiga" class="bg-white pt-6 pb-8">
    <div class="max-w-7xl mx-auto px-6">

      <!-- Header con t√≠tulo y selector de temporada -->
      <div class="flex items-center justify-between mb-4">
        <h2 id="categoriasTitle" class="text-sm font-bold text-gray-300 uppercase tracking-widest">Resultados</h2>
        <div class="flex items-center gap-2" id="seasonDropdownWrap">
          <label class="text-xs font-bold text-gray-400 uppercase tracking-wider hidden sm:inline">Temporada</label>
          <select id="seasonSelect" class="text-sm font-bold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg px-3 py-1.5 cursor-pointer focus:outline-none focus:ring-2 focus:ring-adesa-green/50 transition-colors">
            {seasonsArr.map(s => (
              <option value={s} selected={s === currentSeason}>{s}</option>
            ))}
          </select>
        </div>
      </div>

      <!-- Overview: Vista Semanal de Resultados -->
      <div id="overviewPanel">
        <!-- Quick Category Selector -->
        <div class="flex items-center justify-center gap-3 mb-4">
          <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Ver clasificaci√≥n:</label>
          <select id="quickCatSelect" class="text-sm font-semibold text-gray-700 bg-white border border-gray-200 rounded-lg px-3 py-2 cursor-pointer hover:border-adesa-green focus:outline-none focus:ring-2 focus:ring-adesa-green/30 transition-colors">
            <option value="">Seleccionar categor√≠a...</option>
          </select>
        </div>

        <!-- Week Navigator -->
        <div class="flex items-center justify-center gap-3 mb-6" id="weekNavigator">
          <button id="weekPrev" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-adesa-green hover:text-white flex items-center justify-center text-gray-400 transition-all duration-200" title="Semana anterior">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
          </button>
          <div class="flex flex-col items-center gap-1">
            <span id="weekLabel" class="text-base font-black text-gray-800 tracking-tight min-w-[220px] text-center select-none"></span>
            <button id="weekToday" class="hidden text-[10px] font-bold text-adesa-green hover:text-white hover:bg-adesa-green border border-adesa-green/30 px-3 py-0.5 rounded-full transition-all">Volver a esta semana</button>
          </div>
          <button id="weekNext" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-adesa-green hover:text-white flex items-center justify-center text-gray-400 transition-all duration-200" title="Semana siguiente">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          </button>
        </div>

        <!-- Weekly Results List -->
        <div class="max-w-5xl mx-auto">
          <div id="weeklyResults"></div>
          <div id="noWeekData" class="hidden text-center py-10 text-gray-400">
            <p class="text-lg font-bold">No hay datos para esta temporada</p>
            <p class="text-sm mt-1">Los datos estar√°n disponibles cuando comience la temporada</p>
          </div>
        </div>
      </div>

      <!-- Panel de detalle (oculto por defecto) -->
      <div id="detailPanel" class="hidden">
        <div class="flex items-center justify-between mb-5">
          <button id="btnVolverOverview" class="flex items-center gap-2 text-adesa-green hover:text-gray-900 font-semibold text-sm transition-colors group">
            <span class="transform group-hover:-translate-x-1 transition-transform">‚Üê</span> Volver
          </button>
          <div id="phaseSelector" class="flex items-center gap-2">
            <!-- Selector de fase/grupo inyectado por JS -->
          </div>
        </div>
        <div id="detailContent">
          <!-- Relleno din√°mico por JavaScript -->
        </div>
      </div>
    </div>
  </section>

  <!-- Datos de liga serializados para JavaScript -->
  <script define:vars={{ ligaDataJSON, equiposOverviewJSON, teamPhasesJSON, seasonsJSON, currentSeason, logoMapJSON, baseUrl, weeklyTeamDataJSON }}>
    window.__ligaData = JSON.parse(ligaDataJSON);
    window.__overviewData = JSON.parse(equiposOverviewJSON);
    window.__teamPhases = JSON.parse(teamPhasesJSON);
    window.__seasons = JSON.parse(seasonsJSON);
    window.__currentSeason = currentSeason;
    window.__logoMap = JSON.parse(logoMapJSON);
    window.__baseUrl = baseUrl;
    window.__weeklyTeamData = JSON.parse(weeklyTeamDataJSON);
  </script>

  <!-- Script Zona Liga -->
  <script>
    // ========== ZONA LIGA - WEEKLY VIEW + DETAIL PANEL ==========
    const _ld = (window as any).__ligaData || {};
    const _od = (window as any).__overviewData || [];
    const _tp = (window as any).__teamPhases || {};
    const _logoMap = (window as any).__logoMap || [];
    const _baseUrl = (window as any).__baseUrl || '';
    const _weeklyData = (window as any).__weeklyTeamData || [];
    const detailPanel = document.getElementById('detailPanel');
    const overviewPanel = document.getElementById('overviewPanel');
    const detailContent = document.getElementById('detailContent');
    const zonaLiga = document.getElementById('zonaLiga');
    const categoriasTitle = document.getElementById('categoriasTitle');
    const btnVolver = document.getElementById('btnVolverOverview');
    const seasonSelect = document.getElementById('seasonSelect') as HTMLSelectElement;
    const phaseSelector = document.getElementById('phaseSelector');
    const weeklyResultsEl = document.getElementById('weeklyResults');
    const noWeekData = document.getElementById('noWeekData');
    const weekLabelEl = document.getElementById('weekLabel');
    const weekPrevBtn = document.getElementById('weekPrev');
    const weekNextBtn = document.getElementById('weekNext');
    const weekTodayBtn = document.getElementById('weekToday');
    const weekNavigator = document.getElementById('weekNavigator');

    // ‚îÄ‚îÄ Logo helper ‚îÄ‚îÄ
    function getTeamLogo(teamName: string, size: number = 20): string {
      const lower = teamName.toLowerCase();
      for (const [patterns, file] of _logoMap) {
        for (const pat of patterns) {
          if (lower.includes(pat)) {
            const src = (file as string).startsWith('../') ? `${_baseUrl}/${(file as string).slice(3)}` : `${_baseUrl}/logos/${file}`;
            return `<img src="${src}" alt="" style="width:${size}px;height:${size}px;object-fit:contain;border-radius:50%;flex-shrink:0;" loading="lazy">`;
          }
        }
      }
      return '';
    }

    // ‚îÄ‚îÄ Week helpers ‚îÄ‚îÄ
    const _meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const _diasSemana = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];

    function getMonday(d: Date): Date {
      const date = new Date(d);
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      date.setDate(diff);
      date.setHours(0, 0, 0, 0);
      return date;
    }

    function getSunday(mon: Date): Date {
      const sun = new Date(mon);
      sun.setDate(sun.getDate() + 6);
      sun.setHours(23, 59, 59, 999);
      return sun;
    }

    function parseMatchDate(s: string): Date {
      const [d, m, y] = s.split('/').map(Number);
      return new Date(y, m - 1, d);
    }

    function sameWeek(a: Date, b: Date): boolean {
      return getMonday(a).getTime() === getMonday(b).getTime();
    }

    function formatWeekLabel(mon: Date): string {
      const sun = new Date(mon);
      sun.setDate(sun.getDate() + 6);
      return mon.getDate() + ' ' + _meses[mon.getMonth()] + ' \u2013 ' + sun.getDate() + ' ' + _meses[sun.getMonth()] + ' ' + sun.getFullYear();
    }

    function formatMatchDay(fechaStr: string, hora: string): string {
      const d = parseMatchDate(fechaStr);
      const dia = _diasSemana[d.getDay()];
      const txt = dia + ' ' + d.getDate() + ' ' + _meses[d.getMonth()];
      return hora ? txt + ' \u00b7 ' + hora : txt;
    }

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let currentSeason = seasonSelect?.value || '';
    let currentTeamName: string | null = null;
    let currentCatBase: string | null = null;
    let currentWeekMonday = getMonday(new Date());
    const todayWeekMonday = getMonday(new Date());
    const quickCatSelect = document.getElementById('quickCatSelect') as HTMLSelectElement;

    function populateQuickCatSelect() {
      if (!quickCatSelect) return;
      const teams = _weeklyData.filter((t: any) => t.temporada === currentSeason);
      teams.sort((a: any, b: any) => {
        const na = _nivelOrder[a.nivel] || 0;
        const nb = _nivelOrder[b.nivel] || 0;
        return na !== nb ? nb - na : a.nombre.localeCompare(b.nombre);
      });
      let html = '<option value="">Seleccionar categor√≠a...</option>';
      const grupos: Record<string, any[]> = { 'Masculino': [], 'Femenino': [], 'Mixto': [] };
      for (const t of teams) {
        if (t.genero === 'Masculino') grupos['Masculino'].push(t);
        else if (t.genero === 'Femenino') grupos['Femenino'].push(t);
        else grupos['Mixto'].push(t);
      }
      for (const [label, list] of Object.entries(grupos)) {
        if (list.length > 0) {
          html += '<optgroup label="' + label + '">';
          for (const t of list) {
            html += '<option value="' + t.cat + '" data-nombre="' + t.nombre + '">' + t.nombre + '</option>';
          }
          html += '</optgroup>';
        }
      }
      quickCatSelect.innerHTML = html;
    }

    if (quickCatSelect) {
      quickCatSelect.addEventListener('change', () => {
        const cat = quickCatSelect.value;
        if (!cat) return;
        const opt = quickCatSelect.options[quickCatSelect.selectedIndex];
        const nombre = opt.getAttribute('data-nombre') || '';
        mostrarDetalle(cat, undefined, nombre);
        quickCatSelect.value = '';
      });
    }

    function updateCarouselFilter() {
      const opts: any = {};
      if (currentSeason) opts.temporada = currentSeason;
      if (currentCatBase) opts.catBase = currentCatBase;
      if ((window as any).__filterCarousel) {
        (window as any).__filterCarousel(opts);
      }
    }

    // ‚îÄ‚îÄ Category level order ‚îÄ‚îÄ
    const _nivelOrder: Record<string, number> = { 'Senior': 8, 'Sub-22': 7, 'Junior': 6, 'Cadete': 5, 'Infantil': 4, 'Minibasket': 3, 'Mini': 3, 'PreMini': 2, 'Babybasket': 1 };
    function nivelSort(a: any, b: any) {
      const na = _nivelOrder[a.nivel] || 0;
      const nb = _nivelOrder[b.nivel] || 0;
      return na !== nb ? nb - na : a.nombre.localeCompare(b.nombre);
    }

    // ‚îÄ‚îÄ Weekly View Rendering ‚îÄ‚îÄ
    function renderWeeklyView() {
      if (!weeklyResultsEl || !weekLabelEl) return;
      const teams = _weeklyData.filter((t: any) => t.temporada === currentSeason);
      const monday = currentWeekMonday;
      const sunday = getSunday(monday);
      weekLabelEl.textContent = formatWeekLabel(monday);
      if (weekTodayBtn) weekTodayBtn.classList.toggle('hidden', sameWeek(monday, todayWeekMonday));

      if (teams.length === 0) {
        weeklyResultsEl.innerHTML = '';
        if (noWeekData) noWeekData.classList.remove('hidden');
        return;
      }
      if (noWeekData) noWeekData.classList.add('hidden');

      // Enrich each team with its week matches
      const enriched = teams.map((team: any) => {
        const wm = (team.partidos || []).filter((m: any) => {
          const d = parseMatchDate(m.f);
          return d >= monday && d <= sunday;
        });
        return { ...team, weekMatches: wm };
      });

      // Split by gender
      const masc = enriched.filter((t: any) => t.genero === 'Masculino');
      const fem = enriched.filter((t: any) => t.genero === 'Femenino');
      const mixto = enriched.filter((t: any) => t.genero !== 'Masculino' && t.genero !== 'Femenino');
      masc.sort(nivelSort); fem.sort(nivelSort); mixto.sort(nivelSort);

      let html = '';
      html += renderGenderSection('MASCULINO', masc, 'masc');
      html += renderGenderSection('FEMENINO', fem, 'fem');
      if (mixto.length) html += renderGenderSection('MIXTO', mixto, 'mixto');

      weeklyResultsEl.innerHTML = html;

      // Bind click events
      weeklyResultsEl.querySelectorAll('.result-row').forEach((row: Element) => {
        row.addEventListener('click', () => {
          const cat = row.getAttribute('data-cat');
          const nombre = row.getAttribute('data-nombre');
          if (cat) mostrarDetalle(cat, undefined, nombre || undefined);
        });
      });
      weeklyResultsEl.querySelectorAll('.rest-team-btn').forEach((btn: Element) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const cat = btn.getAttribute('data-cat');
          const nombre = btn.getAttribute('data-nombre');
          if (cat) mostrarDetalle(cat, undefined, nombre || undefined);
        });
      });
      // Populate quick category selector
      populateQuickCatSelect();
    }

    function renderGenderSection(label: string, teams: any[], id: string): string {
      const withMatch = teams.filter((t: any) => t.weekMatches.length > 0);
      const withoutMatch = teams.filter((t: any) => t.weekMatches.length === 0);
      if (teams.length === 0) return '';

      const colors: Record<string, string> = {
        'masc': 'from-blue-600 to-blue-700',
        'fem': 'from-pink-500 to-pink-600',
        'mixto': 'from-purple-500 to-purple-600'
      };
      const accentBg = colors[id] || 'from-gray-600 to-gray-700';

      let h = '<div class="mb-6">';
      // Section header
      h += '<div class="flex items-center gap-3 mb-3">';
      h += '<span class="inline-block px-4 py-1.5 rounded-lg bg-gradient-to-r ' + accentBg + ' text-white text-[11px] font-black uppercase tracking-[0.15em] shadow-sm">' + label + '</span>';
      h += '<div class="flex-1 h-px bg-gray-200"></div>';
      h += '</div>';

      // Match rows
      if (withMatch.length > 0) {
        h += '<div class="rounded-xl border border-gray-200 overflow-hidden bg-white shadow-sm divide-y divide-gray-100">';
        for (const t of withMatch) {
          for (const m of t.weekMatches) {
            h += renderMatchRow(t, m);
          }
        }
        h += '</div>';
      }

      // "Descansa" row for teams without match (clickeable)
      if (withoutMatch.length > 0) {
        h += '<div class="mt-2 px-4 py-2.5 rounded-lg bg-gray-50 border border-gray-100">';
        h += '<div class="flex items-center gap-2 flex-wrap">';
        h += '<span class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">Descansan:</span>';
        for (const t of withoutMatch) {
          h += '<button class="rest-team-btn text-xs font-semibold text-gray-500 hover:text-adesa-green hover:underline transition-colors" data-cat="' + t.cat + '" data-nombre="' + t.nombre + '">' + t.nombre + '</button>';
          if (withoutMatch.indexOf(t) < withoutMatch.length - 1) h += '<span class="text-gray-300">¬∑</span>';
        }
        h += '</div></div>';
      }

      h += '</div>';
      return h;
    }

    function renderMatchRow(team: any, m: any): string {
      const hasScore = m.ml !== null && m.mv !== null && m.ml !== '' && m.mv !== undefined;
      const isLocal = m.u === 'Local';
      const adesaName = team.nombre;
      const rivalName = m.r;
      const leftName = isLocal ? adesaName : rivalName;
      const rightName = isLocal ? rivalName : adesaName;
      const leftIsAdesa = isLocal;
      const rightIsAdesa = !isLocal;
      const leftLogo = getTeamLogo(leftIsAdesa ? 'ADESA 80' : rivalName, 36);
      const rightLogo = getTeamLogo(rightIsAdesa ? 'ADESA 80' : rivalName, 36);
      const emptyLogo = '<span style="width:36px;height:36px;flex-shrink:0;"></span>';

      let won = false, lost = false;
      if (hasScore) {
        const ml = parseInt(m.ml), mv = parseInt(m.mv);
        const aScore = isLocal ? ml : mv;
        const rScore = isLocal ? mv : ml;
        won = aScore > rScore;
        lost = aScore < rScore;
      }

      const isPast = !hasScore && parseMatchDate(m.f) < new Date();
      const posLabel = team.pos ? team.pos + '\u00ba' : '';
      const record = team.pg + '-' + team.pp;

      // Result badge (W/L/upcoming/postponed)
      let badge = '';
      if (hasScore) {
        badge = won
          ? '<span class="wl-badge wl-win">V</span>'
          : '<span class="wl-badge wl-loss">D</span>';
      } else if (isPast) {
        badge = '<span class="wl-badge wl-postponed">A</span>';
      }

      // Row accent
      const accentClass = hasScore ? (won ? 'row-win' : 'row-loss') : (isPast ? 'row-postponed' : 'row-upcoming');

      let h = '<div class="result-row ' + accentClass + ' flex items-center px-4 sm:px-6 py-4 cursor-pointer hover:bg-gray-50/80 transition-all group" data-cat="' + team.cat + '" data-nombre="' + team.nombre + '">';

      // Badge column
      h += '<div class="w-8 flex-shrink-0 flex items-center justify-center">' + badge + '</div>';

      // Left team (right-aligned)
      h += '<div class="flex-1 flex items-center justify-end gap-3 sm:gap-4 min-w-0">';
      h += '<div class="text-right min-w-0">';
      h += '<span class="block text-sm sm:text-base font-bold truncate ' + (leftIsAdesa ? 'text-gray-900' : 'text-gray-600') + '">' + leftName + '</span>';
      if (leftIsAdesa && posLabel) h += '<span class="block text-[11px] font-bold text-adesa-green leading-none mt-1">' + posLabel + ' ¬∑ ' + record + '</span>';
      h += '</div>';
      h += (leftLogo || emptyLogo);
      h += '</div>';

      // Score center
      h += '<div class="w-[100px] sm:w-[130px] flex-shrink-0 mx-3 sm:mx-5 flex flex-col items-center">';
      if (hasScore) {
        const scoreBg = won ? 'bg-adesa-green' : 'bg-gray-800';
        h += '<div class="' + scoreBg + ' text-white font-black text-lg sm:text-xl px-4 py-2 rounded-xl tracking-wider text-center leading-none w-full shadow-md">' + m.ml + ' - ' + m.mv + '</div>';
      } else if (isPast) {
        h += '<div class="bg-amber-100 text-amber-700 font-bold text-xs px-3 py-2 rounded-xl text-center w-full">APLAZADO</div>';
      } else {
        h += '<div class="bg-gray-100 text-gray-600 font-semibold text-xs px-3 py-2 rounded-xl text-center w-full leading-tight">';
        const partes = m.f ? m.f.split('/') : [];
        const fechaCorta = partes.length === 3 ? partes[0] + '/' + partes[1] : m.f;
        h += fechaCorta + (m.h ? '<br><span class="text-gray-500">' + m.h + '</span>' : '');
        h += '</div>';
      }
      h += '</div>';

      // Right team (left-aligned)
      h += '<div class="flex-1 flex items-center gap-3 sm:gap-4 min-w-0">';
      h += (rightLogo || emptyLogo);
      h += '<div class="min-w-0">';
      h += '<span class="block text-sm sm:text-base font-bold truncate ' + (rightIsAdesa ? 'text-gray-900' : 'text-gray-600') + '">' + rightName + '</span>';
      if (rightIsAdesa && posLabel) h += '<span class="block text-[11px] font-bold text-adesa-green leading-none mt-1">' + posLabel + ' ¬∑ ' + record + '</span>';
      h += '</div>';
      h += '</div>';

      // Arrow hint
      h += '<div class="w-5 flex-shrink-0 flex items-center justify-center text-gray-300 group-hover:text-adesa-green transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></div>';

      h += '</div>';
      return h;
    }

    // ‚îÄ‚îÄ Season change ‚îÄ‚îÄ
    if (seasonSelect) {
      seasonSelect.addEventListener('change', () => {
        currentSeason = seasonSelect.value;
        renderWeeklyView();
        updateCarouselFilter();
      });
    }

    function mostrarOverview() {
      if (detailPanel) detailPanel.classList.add('hidden');
      if (overviewPanel) overviewPanel.classList.remove('hidden');
      if (categoriasTitle) { categoriasTitle.textContent = 'Resultados'; categoriasTitle.classList.remove('hidden'); }
      const seasonWrap = document.getElementById('seasonDropdownWrap');
      if (seasonWrap) seasonWrap.style.display = '';
      if (weekNavigator) weekNavigator.style.display = '';
      currentTeamName = null;
      currentCatBase = null;
      updateCarouselFilter();
      renderWeeklyView();
    }

    function mostrarDetalle(categoria: string, rivalDestacado?: string, teamName?: string) {
      if (!teamName) {
        const match = _od.find((eq: any) => eq.cat === categoria);
        teamName = match?.nombre || '';
      }

      let liga = _ld[categoria];
      if (!liga) {
        const stripped = categoria.replace(/ B$/, '');
        if (stripped !== categoria) liga = _ld[stripped];
      }
      if (!liga || !detailContent || !detailPanel || !overviewPanel) return;

      currentTeamName = teamName || null;
      const catBase = categoria.split(' - ')[0].trim();
      currentCatBase = catBase;
      updateCarouselFilter();

      overviewPanel.classList.add('hidden');
      detailPanel.classList.remove('hidden');
      if (categoriasTitle) categoriasTitle.classList.add('hidden');
      const seasonWrap = document.getElementById('seasonDropdownWrap');
      if (seasonWrap) seasonWrap.style.display = 'none';

      // ‚îÄ‚îÄ Phase/Group selector ‚îÄ‚îÄ
      const phases = teamName ? (_tp[teamName] || []) : [];
      if (phaseSelector) {
        if (phases.length > 1) {
          let selHTML = '<label class="text-xs font-bold text-gray-400 uppercase tracking-wider whitespace-nowrap">Fase / Grupo</label>';
          selHTML += '<select id="phaseSelect" class="text-sm font-bold text-gray-700 bg-gray-100 border border-gray-200 rounded-lg px-3 py-1.5 cursor-pointer focus:outline-none focus:ring-2 focus:ring-adesa-green/50 transition-colors">';
          for (const opt of phases) {
            const label = opt.group === '√öNICO' ? opt.phase : opt.phase + ' ‚Äî ' + opt.group;
            const sel = opt.cat === categoria ? 'selected' : '';
            selHTML += '<option value="' + opt.cat + '" ' + sel + '>' + label + '</option>';
          }
          selHTML += '</select>';
          phaseSelector.innerHTML = selHTML;
          const phaseSelect = document.getElementById('phaseSelect') as HTMLSelectElement;
          if (phaseSelect) {
            phaseSelect.addEventListener('change', () => {
              mostrarDetalle(phaseSelect.value, undefined, teamName);
            });
          }
        } else {
          phaseSelector.innerHTML = '';
        }
      }

      renderLigaDetail(liga, rivalDestacado);

      setTimeout(() => {
        if (zonaLiga) zonaLiga.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    function renderLigaDetail(liga: any, rivalDestacado?: string) {
      if (!detailContent) return;
      let html = '';

      html += '<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">';

      // --- CLASIFICACI√ìN (sin scroll horizontal) ---
      html += '<div class="lg:col-span-1">';
      html += '<div class="bg-white rounded-2xl border-2 border-gray-100 overflow-hidden shadow-lg sticky top-4">';
      html += '<div class="bg-adesa-dark text-white px-4 py-3"><h3 class="font-bold text-sm tracking-wide">üìä Clasificaci√≥n</h3></div>';
      html += '<table class="w-full text-[11px]" style="table-layout:fixed;">';
      html += '<thead><tr class="bg-gray-50 text-gray-500 uppercase tracking-wider" style="font-size:9px;">';
      html += '<th style="width:24px;" class="py-1.5 text-center">#</th>';
      html += '<th class="py-1.5 text-left pl-1">Equipo</th>';
      html += '<th style="width:22px;" class="py-1.5 text-center">PJ</th>';
      html += '<th style="width:22px;" class="py-1.5 text-center">G</th>';
      html += '<th style="width:22px;" class="py-1.5 text-center">P</th>';
      html += '<th style="width:28px;" class="py-1.5 text-center">PTS</th>';
      html += '</tr></thead><tbody>';

      for (const eq of liga.c) {
        const esAdesa = eq.equipo === 'ADESA 80' || (eq.equipo && eq.equipo.includes('ADESA'));
        const esRival = rivalDestacado && eq.equipo && eq.equipo.toUpperCase() === rivalDestacado.toUpperCase();
        const bg = esAdesa ? 'bg-adesa-green/10' : esRival ? 'bg-amber-50' : '';
        const fw = esAdesa ? 'font-bold' : '';
        const logo = getTeamLogo(eq.equipo, 18);
        html += '<tr class="' + bg + ' ' + fw + ' border-b border-gray-50 hover:bg-gray-50 transition-colors">';
        html += '<td class="py-2 text-center font-bold ' + (esAdesa ? 'text-adesa-green' : 'text-gray-400') + '">' + eq.posicion + '</td>';
        html += '<td class="py-2 pl-1 ' + (esAdesa ? 'text-adesa-green font-bold' : 'text-gray-700') + '">';
        html += '<div style="display:flex;align-items:center;gap:4px;overflow:hidden;">';
        html += logo || '<span style="width:18px;height:18px;flex-shrink:0;"></span>';
        html += '<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + eq.equipo + '</span>';
        html += '</div></td>';
        html += '<td class="py-2 text-center text-gray-600">' + eq.partidos_jugados + '</td>';
        html += '<td class="py-2 text-center text-green-600 font-medium">' + eq.partidos_ganados + '</td>';
        html += '<td class="py-2 text-center text-red-500 font-medium">' + eq.partidos_perdidos + '</td>';
        html += '<td class="py-2 text-center font-bold ' + (esAdesa ? 'text-adesa-green' : 'text-gray-900') + '">' + eq.puntos + '</td>';
        html += '</tr>';
      }
      html += '</tbody></table></div></div>';

      // --- JORNADAS ---
      html += '<div class="lg:col-span-2">';
      html += '<div class="bg-white rounded-2xl border-2 border-gray-100 overflow-hidden shadow-lg">';
      html += '<div class="bg-adesa-dark text-white px-5 py-3 flex items-center justify-between">';
      html += '<h3 class="font-bold text-sm tracking-wide">üìÖ Jornadas</h3>';
      html += '<span class="text-xs text-white/60">' + liga.j.length + ' jornadas</span>';
      html += '</div>';
      html += '<div class="divide-y divide-gray-100 max-h-[650px] overflow-y-auto zona-liga-scroll">';

      for (const jornada of liga.j) {
        html += '<div class="jornada-bloque">';
        html += '<div class="px-5 py-2.5 bg-gray-50/80 text-xs font-bold text-gray-600 uppercase tracking-wider border-b border-gray-100">' + jornada.n + '</div>';

        for (const p of jornada.p) {
          const esAdesa = p.a;
          const tieneRes = p.ml !== null && p.mv !== null && p.ml !== '' && p.mv !== '';
          const border = esAdesa ? 'border-l-4 border-l-adesa-green bg-adesa-green/5' : 'border-l-4 border-l-transparent';
          html += '<div class="px-3 py-2 flex items-center text-xs ' + border + ' hover:bg-gray-50/50 transition-colors" style="gap:4px;">';

          // Local: nombre + logo
          const lAdesa = p.l === 'ADESA 80' || (p.l && p.l.includes('ADESA'));
          const lLogo = getTeamLogo(p.l, 18);
          html += '<div style="flex:1;display:flex;align-items:center;justify-content:flex-end;gap:5px;overflow:hidden;min-width:0;">';
          html += '<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" class="' + (lAdesa ? 'font-bold text-adesa-green' : 'text-gray-700') + '">' + p.l + '</span>';
          html += lLogo;
          html += '</div>';

          // Score / date
          if (tieneRes) {
            html += '<div class="px-2 py-1 rounded-lg bg-gray-900 text-white font-bold text-xs whitespace-nowrap text-center" style="min-width:54px;">' + p.ml + ' - ' + p.mv + '</div>';
          } else {
            const partes = p.f ? p.f.split('/') : [];
            const fechaP = partes.length === 3 ? new Date(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0])) : null;
            const esPasado = fechaP && fechaP < new Date();
            if (esPasado) {
              html += '<div class="px-2 py-1 rounded-lg bg-red-100 text-red-600 font-bold whitespace-nowrap text-center" style="min-width:54px;font-size:10px;">APLAZADO</div>';
            } else {
              html += '<div class="px-2 py-1 rounded-lg bg-gray-100 text-gray-400 whitespace-nowrap text-center" style="min-width:54px;font-size:10px;">' + p.f + (p.h ? ' ¬∑ ' + p.h : '') + '</div>';
            }
          }

          // Visitante: logo + nombre
          const vAdesa = p.v === 'ADESA 80' || (p.v && p.v.includes('ADESA'));
          const vLogo = getTeamLogo(p.v, 18);
          html += '<div style="flex:1;display:flex;align-items:center;gap:5px;overflow:hidden;min-width:0;">';
          html += vLogo;
          html += '<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" class="' + (vAdesa ? 'font-bold text-adesa-green' : 'text-gray-700') + '">' + p.v + '</span>';
          html += '</div>';

          html += '</div>';
        }
        html += '</div>';
      }

      html += '</div></div></div>';
      html += '</div>';

      // === H2H ===
      if (rivalDestacado) {
        const h2h: any[] = [];
        for (const j of liga.j) {
          for (const p of j.p) {
            if (!p.a) continue;
            const rUp = rivalDestacado.toUpperCase();
            if ((p.l.toUpperCase() === rUp || p.v.toUpperCase() === rUp) && p.ml !== null && p.mv !== null) {
              h2h.push({ ...p, jornada: j.n });
            }
          }
        }
        if (h2h.length > 0) {
          html += '<div class="mt-8 bg-white rounded-2xl border-2 border-gray-100 overflow-hidden shadow-lg">';
          html += '<div class="bg-amber-500 text-white px-5 py-3"><h3 class="font-bold text-sm tracking-wide">‚öîÔ∏è Enfrentamientos directos vs ' + rivalDestacado + '</h3></div>';
          html += '<div class="divide-y divide-gray-50">';
          for (const p of h2h) {
            const adLocal = p.l === 'ADESA 80' || (p.l && p.l.includes('ADESA'));
            const ptsAdesa = adLocal ? parseInt(p.ml) : parseInt(p.mv);
            const ptsRival = adLocal ? parseInt(p.mv) : parseInt(p.ml);
            const victoria = ptsAdesa > ptsRival;
            const badgeCls = victoria ? 'bg-adesa-green text-white' : 'bg-red-500 text-white';
            const badge = victoria ? 'V' : 'D';
            html += '<div class="px-5 py-4 flex items-center gap-4">';
            html += '<span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold ' + badgeCls + '">' + badge + '</span>';
            html += '<div class="flex-1">';
            html += '<p class="text-sm font-medium text-gray-900">' + p.l + ' <span class="font-bold text-lg mx-1">' + p.ml + ' - ' + p.mv + '</span> ' + p.v + '</p>';
            html += '<p class="text-xs text-gray-500">' + p.jornada + ' ¬∑ ' + p.f + '</p>';
            html += '</div></div>';
          }
          html += '</div></div>';
        }
      }

      detailContent.innerHTML = html;
    }

    // ‚îÄ‚îÄ Week navigation ‚îÄ‚îÄ
    if (weekPrevBtn) {
      weekPrevBtn.addEventListener('click', () => {
        currentWeekMonday = new Date(currentWeekMonday);
        currentWeekMonday.setDate(currentWeekMonday.getDate() - 7);
        renderWeeklyView();
      });
    }
    if (weekNextBtn) {
      weekNextBtn.addEventListener('click', () => {
        currentWeekMonday = new Date(currentWeekMonday);
        currentWeekMonday.setDate(currentWeekMonday.getDate() + 7);
        renderWeeklyView();
      });
    }
    if (weekTodayBtn) {
      weekTodayBtn.addEventListener('click', () => {
        currentWeekMonday = getMonday(new Date());
        renderWeeklyView();
      });
    }

    // Click en tarjetas del carrusel (delegaci√≥n por si se reconstruyen)
    const carouselTrack = document.getElementById('carousel-track');
    if (carouselTrack) {
      carouselTrack.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target.closest('a')) return;
        const card = target.closest('.mc') as HTMLElement;
        if (!card) return;
        const cat = card.dataset.liga;
        const rival = card.dataset.rival;
        if (cat) mostrarDetalle(cat, rival || undefined);
      });
    }

    // Bot√≥n volver
    if (btnVolver) {
      btnVolver.addEventListener('click', mostrarOverview);
    }

    // Render inicial
    renderWeeklyView();
    populateQuickCatSelect();
    if (currentSeason) {
      updateCarouselFilter();
    }
  </script>

  <style>
    .zona-liga-scroll {
      scrollbar-width: thin;
      scrollbar-color: #d1d5db transparent;
    }
    .zona-liga-scroll::-webkit-scrollbar { width: 6px; }
    .zona-liga-scroll::-webkit-scrollbar-track { background: transparent; }
    .zona-liga-scroll::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
    .zona-liga-scroll::-webkit-scrollbar-thumb:hover { background-color: #9ca3af; }

    /* Result rows */
    .result-row { position: relative; }
    .result-row.row-win { border-left: 3px solid #22c55e; }
    .result-row.row-loss { border-left: 3px solid #ef4444; }
    .result-row.row-postponed { border-left: 3px solid #f59e0b; }
    .result-row.row-upcoming { border-left: 3px solid transparent; }

    /* W/L badges */
    .wl-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 26px; height: 26px; border-radius: 50%;
      font-size: 11px; font-weight: 800; line-height: 1;
    }
    .wl-win { background: #dcfce7; color: #16a34a; }
    .wl-loss { background: #fef2f2; color: #dc2626; }
    .wl-postponed { background: #fef3c7; color: #d97706; }

    /* Hover effect on rest team buttons */
    .rest-team-btn { cursor: pointer; }
  </style>
</Layout>
