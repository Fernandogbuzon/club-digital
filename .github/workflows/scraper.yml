name: ðŸ¤– Actualizar Partidos

on:
  # Estrategia de actualizaciÃ³n inteligente:
  # - Lunes a Viernes: cada 4 horas (horarios se actualizan entre semana)
  # - SÃ¡bado y Domingo: cada 30 minutos (partidos en vivo)
  schedule:
    # Lunes a Viernes: 0:00, 4:00, 8:00, 12:00, 16:00, 20:00
    - cron: '0 0,4,8,12,16,20 * * 1-5'
    # SÃ¡bado y Domingo: cada 30 minutos
    - cron: '*/30 * * * 0,6'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

jobs:
  scrape-partidos:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ðŸ”§ Instalar dependencias
        run: npm ci
      
      - name: ðŸ€ Ejecutar scraper
        run: npm run scrape:partidos
        continue-on-error: false
      
      - name: ðŸ“Š Verificar cambios
        id: cambios
        run: |
          if git diff --quiet src/data/partidos.json; then
            echo "hay_cambios=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No hay cambios en los partidos"
          else
            echo "hay_cambios=true" >> $GITHUB_OUTPUT
            echo "âœ… Se detectaron cambios en los partidos"
          fi
      
      - name: ðŸ’¾ Commit y push cambios
        if: steps.cambios.outputs.hay_cambios == 'true'
        run: |
          git config --local user.name "GitHub Actions Bot"
          git config --local user.email "actions@github.com"
          git add src/data/partidos.json
          
          # Obtener timestamp
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Commit con mensaje descriptivo
          git commit -m "ðŸ¤– Actualizar partidos - ${TIMESTAMP}" \
                     -m "ActualizaciÃ³n automÃ¡tica de calendario de partidos" \
                     -m "[skip ci]"
          
          git push
      
      - name: ðŸ“ Resumen
        if: always()
        run: |
          echo "### ðŸ€ Scraper de Partidos ADESA 80" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Estado:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cambios detectados:** ${{ steps.cambios.outputs.hay_cambios }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "src/data/partidos.json" ]; then
            TOTAL=$(jq '.total_partidos' src/data/partidos.json)
            echo "**Total partidos:** ${TOTAL}" >> $GITHUB_STEP_SUMMARY
          fi
