name: "1. Calendario - Actualizar fechas y horarios"

# Scraper completo: actualiza todas las competiciones, fechas, horarios
# Se ejecuta 1 vez al dia a las 7:00 (hora España)
# Tambien genera partidos_hoy.json para el disparador

on:
  schedule:
    # 7:00 España = 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

concurrency:
  group: scraper-calendario
  cancel-in-progress: true

jobs:
  actualizar-calendario:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Instalar dependencias
        run: |
          pip install playwright playwright-stealth
          playwright install chromium
          playwright install-deps chromium

      - name: Ejecutar scraper completo
        run: |
          sudo apt-get install -y xvfb > /dev/null 2>&1
          xvfb-run --auto-servernum --server-args="-screen 0 1366x768x24" \
            python scraper_competicion.py 2>&1

      - name: Commit y push
        run: |
          git config --local user.name "GitHub Actions Bot"
          git config --local user.email "actions@github.com"
          
          # Añadir TODO (tracked + untracked) de las carpetas relevantes
          git add -A src/data/ 2>/dev/null || true
          git add partidos_hoy.json comp_url_map.json intentos_resultados.json 2>/dev/null || true
          
          # Solo commitear si hay cambios staged
          if git diff --cached --quiet; then
            echo "Sin cambios que commitear"
          else
            TIMESTAMP=$(TZ='Europe/Madrid' date '+%d/%m/%Y %H:%M')
            git commit -m "Calendario actualizado - ${TIMESTAMP}" \
                       -m "Actualizacion automatica de fechas y horarios"
            git push
          fi

      - name: Detectar partidos pasados sin resultado
        id: pendientes
        run: |
          python -c "
          import json, os
          from pathlib import Path
          from datetime import datetime, timedelta

          cfg = json.loads(Path('team_config.json').read_text())
          SLUG = cfg['team_slug']
          DURATION = cfg.get('match_duration_hours', 2.5)
          MAX = cfg.get('max_retry_attempts', 3)
          DATA = Path('src/data')
          INTENTOS_FILE = Path('intentos_resultados.json')
          ahora = datetime.now()

          intentos = {}
          if INTENTOS_FILE.exists():
              try:
                  intentos = json.loads(INTENTOS_FILE.read_text())
                  intentos = {k:v for k,v in intentos.items()
                              if (ahora - datetime.fromisoformat(v.get('ultimo','2000-01-01'))).total_seconds() < 48*3600}
              except: pass

          pendientes = 0
          for f in DATA.rglob(f'{SLUG}*.json'):
              try:
                  data = json.loads(f.read_text())
                  if not isinstance(data, list): continue
              except: continue
              for p in data:
                  if p.get('es_resultado'): continue
                  fecha = p.get('fecha','')
                  hora = p.get('hora','')
                  pid = p.get('id','')
                  if not fecha or not pid: continue
                  try:
                      d,m,y = fecha.split('/')
                      dt = datetime(int(y),int(m),int(d))
                      if hora and ':' in hora:
                          h,mi = hora.split(':')
                          dt = dt.replace(hour=int(h),minute=int(mi))
                      else:
                          dt = dt.replace(hour=12)
                  except: continue
                  if dt + timedelta(hours=DURATION) >= ahora: continue
                  n = intentos.get(pid,{}).get('intentos',0)
                  if n >= MAX: continue
                  pendientes += 1

          print(f'Partidos pasados sin resultado: {pendientes}')
          with open(os.environ.get('GITHUB_OUTPUT','/dev/null'), 'a') as f:
              f.write(f'pendientes={\"true\" if pendientes > 0 else \"false\"}\n')
              f.write(f'num={pendientes}\n')
          "

      - name: Disparar scraper de resultados
        if: steps.pendientes.outputs.pendientes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '3-resultados.yml',
              ref: 'main',
            });
            console.log(`Disparado scraper de resultados (${{ steps.pendientes.outputs.num }} pendientes)`);

      - name: Resumen
        if: always()
        run: |
          echo "### Scraper Calendario" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(TZ='Europe/Madrid' date '+%d/%m/%Y %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**Cambios:** ${{ steps.cambios.outputs.hay_cambios }}" >> $GITHUB_STEP_SUMMARY
